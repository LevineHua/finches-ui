{"version":3,"file":"ApiSelect.vue_vue_type_script_lang.mjs","sources":["../../../../../../../../../components/form/src/components/ApiSelect.vue"],"sourcesContent":["<!--\n * @Description: \n * @Author: 华松林\n * @Date: 2021-08-23 10:58:42\n * @LastEditors: 华松林\n * @LastEditTime: 2021-12-01 11:07:32\n * @FilePath: /finches-ui/packages/components/form/src/components/ApiSelect.vue\n-->\n<template>\n  <el-select v-model=\"state\" v-bind=\"attrs\" @change=\"handleChange\">\n    <el-option\n      v-for=\"item in getOptions\"\n      :key=\"item.value\"\n      :label=\"item.label\"\n      :value=\"item.value\"\n    />\n    <template v-for=\"item in Object.keys($slots)\" #[item]=\"data\">\n      <slot :name=\"item\" v-bind=\"data\"></slot>\n    </template>\n  </el-select>\n</template>\n<script lang=\"ts\">\nimport { computed, defineComponent, ref, unref, watchEffect, watch } from 'vue'\nimport { omit, get } from 'lodash-es'\nimport { propTypes } from '@finches-ui/utils/propTypes'\nimport { isFunction } from '@finches-ui/utils/is'\nimport { useRuleFormItem } from '../hooks/useFormItem'\nimport { useAttrs } from '../hooks/useAttrs'\nimport type { PropType } from 'vue'\n\nexport default defineComponent({\n  name: 'ApiSelect',\n  inheritAttrs: false,\n  props: {\n    // 除了以下 props 还可使用 element-plus 的 Select 属性\n    value: propTypes.oneOfType([\n      propTypes.object,\n      propTypes.number,\n      propTypes.string,\n      propTypes.array,\n    ]),\n    numberToString: propTypes.bool,\n    api: {\n      // eslint-disable-next-line no-undef\n      type: Function as PropType<(arg?: any) => Promise<any[]>>,\n      default: null,\n    },\n    // api params\n    params: {\n      // eslint-disable-next-line no-undef\n      type: Object as PropType<any>,\n      default: () => ({}),\n    },\n    resultField: propTypes.string.def(''),\n    labelField: propTypes.string.def('label'),\n    valueField: propTypes.string.def('value'),\n  },\n  emits: ['options-change', 'change'],\n  setup(props, { emit }) {\n    const options: any = ref([])\n    const loading = ref(false)\n    const isFirstLoad = ref(true)\n    const emitData = ref<any[]>([])\n    const attrs = useAttrs()\n\n    const [state] = useRuleFormItem(props, 'value', 'change', emitData)\n\n    const getOptions = computed(() => {\n      const { labelField, valueField, numberToString } = props\n\n      return unref(options).reduce((prev: any, next) => {\n        if (next) {\n          const value = next[valueField]\n          prev.push({\n            label: next[labelField],\n            value: numberToString ? `${value}` : value,\n            ...omit(next, [labelField, valueField]),\n          })\n        }\n        return prev\n      }, [])\n    })\n\n    watchEffect(() => {\n      !unref(loading) && fetch()\n    })\n\n    watch(\n      () => props.params,\n      () => {\n        !unref(isFirstLoad) && fetch()\n      },\n      { deep: true }\n    )\n\n    async function fetch() {\n      const api = props.api\n      if (!api || !isFunction(api)) return\n      options.value = []\n      try {\n        loading.value = true\n        const res = await api(props.params)\n        if (Array.isArray(res)) {\n          options.value = res\n          return\n        }\n        if (props.resultField) {\n          options.value = get(res, props.resultField) || []\n        }\n      } catch (error) {\n        console.warn(error)\n      } finally {\n        // loading.value = false\n      }\n    }\n\n    function emitChange() {\n      emit('options-change', unref(getOptions))\n    }\n\n    function handleChange(_, ...args) {\n      emitData.value = args\n    }\n\n    return {\n      getOptions,\n      emitChange,\n      state,\n      attrs,\n      handleChange,\n    }\n  },\n})\n</script>\n"],"names":[],"mappings":";;;;;;;;;AA8BA,aAAe,gBAAgB;AAAA,EAC7B,MAAM;AAAA,EACN,cAAc;AAAA,EACd,OAAO;AAAA,IAEL,OAAO,UAAU,UAAU;AAAA,MACzB,UAAU;AAAA,MACV,UAAU;AAAA,MACV,UAAU;AAAA,MACV,UAAU;AAAA;AAAA,IAEZ,gBAAgB,UAAU;AAAA,IAC1B,KAAK;AAAA,MAEH,MAAM;AAAA,MACN,SAAS;AAAA;AAAA,IAGX,QAAQ;AAAA,MAEN,MAAM;AAAA,MACN,SAAS;AAAO;AAAA,IAElB,aAAa,UAAU,OAAO,IAAI;AAAA,IAClC,YAAY,UAAU,OAAO,IAAI;AAAA,IACjC,YAAY,UAAU,OAAO,IAAI;AAAA;AAAA,EAEnC,OAAO,CAAC,kBAAkB;AAAA,EAC1B,MAAM,OAAO,EAAE,QAAQ;AACrB,UAAM,UAAe,IAAI;AACzB,UAAM,UAAU,IAAI;AACpB,UAAM,cAAc,IAAI;AACxB,UAAM,WAAW,IAAW;AAC5B,UAAM,QAAQ;AAEd,UAAM,CAAC,SAAS,gBAAgB,OAAO,SAAS,UAAU;AAE1D,UAAM,aAAa,SAAS,MAAM;AAChC,YAAM,EAAE,YAAY,YAAY,mBAAmB;AAEnD,aAAO,MAAM,SAAS,OAAO,CAAC,MAAW,SAAS;AAChD,YAAI,MAAM;AACR,gBAAM,QAAQ,KAAK;AACnB,eAAK,KAAK;AAAA,YACR,OAAO,KAAK;AAAA,YACZ,OAAO,iBAAiB,GAAG,UAAU;AAAA,eAClC,KAAK,MAAM,CAAC,YAAY;AAAA;AAAA;AAG/B,eAAO;AAAA,SACN;AAAA;AAGL,gBAAY,MAAM;AAChB,OAAC,MAAM,YAAY;AAAA;AAGrB,UACE,MAAM,MAAM,QACZ,MAAM;AACJ,OAAC,MAAM,gBAAgB;AAAA,OAEzB,EAAE,MAAM;AAGV,2BAAuB;AACrB,YAAM,MAAM,MAAM;AAClB,UAAI,CAAC,OAAO,CAAC,WAAW;AAAM;AAC9B,cAAQ,QAAQ;AAChB,UAAI;AACF,gBAAQ,QAAQ;AAChB,cAAM,MAAM,MAAM,IAAI,MAAM;AAC5B,YAAI,MAAM,QAAQ,MAAM;AACtB,kBAAQ,QAAQ;AAChB;AAAA;AAEF,YAAI,MAAM,aAAa;AACrB,kBAAQ,QAAQ,IAAI,KAAK,MAAM,gBAAgB;AAAA;AAAA,eAE1C,OAAP;AACA,gBAAQ,KAAK;AAAA,gBACb;AAAA;AAAA;AAKJ,0BAAsB;AACpB,WAAK,kBAAkB,MAAM;AAAA;AAG/B,0BAAsB,MAAM,MAAM;AAChC,eAAS,QAAQ;AAAA;AAGnB,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA;AAAA;AAAA;;;;"}